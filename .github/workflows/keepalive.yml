name: Keep Backend Awake

on:
  schedule:
    - cron: "*/10 * * * *" # Cada 10 minutos aprox.
  workflow_dispatch: # Permite ejecutarlo manualmente
  push:
    branches: [main]

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Set random delay (3‚Äì9 min)
        id: jitter
        run: |
          jitter=$((RANDOM % 360 + 180)) # 180s (3min) a 540s (9min)
          echo "Esperando $jitter segundos antes del ping..."
          sleep "$jitter"

      - name: Random ping to Aerotickets API
        run: |
          # Lista de endpoints p√∫blicos del backend
          urls=(
            "https://aerotickets-api.onrender.com/health"
            "https://aerotickets-api.onrender.com/hola"
            "https://aerotickets-api.onrender.com/api/catalog/airports/co"
          )

          # Elegir aleatoriamente uno
          url=${urls[$RANDOM % ${#urls[@]}]}
          echo "üåê Ping aleatorio a: $url"

          # Realizar 2 tipos de peticiones (HEAD y GET)
          for i in {1..2}; do
            echo "Intento $i ‚Üí $url"
            if curl -fsS -m 10 -o /dev/null -w "%{http_code}" "$url"; then
              echo "‚úÖ √âxito al mantener activo el backend."
              exit 0
            else
              echo "‚ö†Ô∏è Fallo (reintentando)..."
              sleep 5
            fi
          done

          echo "‚ùå Todos los intentos fallaron, Render podr√≠a estar dormido."
          exit 1

      - name: Espera aleatoria adicional (1‚Äì2 min)
        run: |
          extra=$((RANDOM % 60 + 60))
          echo "Esperando $extra segundos para cerrar de forma natural..."
          sleep "$extra"